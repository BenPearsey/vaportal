import{r as c,j as e}from"./app-DUSEAaDk.js";import{C as z,a as U,b as I,c as H}from"./card-DLziDOQe.js";import{P as re}from"./progress-BtyeaZGH.js";import{c as ne,B as F}from"./app-logo-icon-niQwcySJ.js";import{D as ae,a as ie,b as ce,c as le,e as oe,f as de}from"./dialog-h4m6KRJP.js";import{X as ue}from"./use-mobile-navigation-xAdiOegP.js";import{U as me}from"./upload-BGDiebbv.js";import{p as K}from"./products-FRIolfiG.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],ee=ne("CircleCheck",fe),Y=new Set(["complete","approved","na"]);function w(l){switch(l){case"uploaded":case"pending_review":return"pending_review";case"approved":case"rejected":case"complete":case"na":return l;default:return"todo"}}function pe(l){var i;return((i=document.cookie.split(";").map(g=>g.trim()).find(g=>g.startsWith(l+"=")))==null?void 0:i.split("=")[1])??""}function he(){var g;const l=(g=document.querySelector('meta[name="csrf-token"]'))==null?void 0:g.content;if(l)return{header:"X-CSRF-TOKEN",token:l};const i=pe("XSRF-TOKEN");return i?{header:"X-XSRF-TOKEN",token:decodeURIComponent(i)}:null}function G(l){const i=(l.task.action_type||"").toLowerCase().trim();return i==="upload"||i==="file-upload"||l.task.requires_review===!0}function te(l){if(!l)return null;const i=new Date(l);return Number.isNaN(i.getTime())?l.split("T")[0]??l:i.toLocaleDateString(void 0,{month:"short",day:"2-digit",year:"numeric"})}function ge({saleId:l,role:i="client",onlyStageKeys:g,showCompleteOnce:S=!1,titleMeta:p}){const v=i==="admin"?`/admin/sales/${l}`:`/${i}/sales/${l}`,[t,$]=c.useState(null),[J,O]=c.useState(!0),[E,q]=c.useState(null),[A,B]=c.useState(!1),[x,u]=c.useState([]),[Q,D]=c.useState(!1),h=c.useMemo(()=>`va:checklist:completeShown:${i}:${l}`,[i,l]),[y,N]=c.useState(!1),_=c.useRef(null),L=c.useCallback(async()=>{const s=await fetch(`${v}/checklist/ensure`,{headers:{Accept:"application/json"},credentials:"same-origin"});if(!s.ok&&s.status!==422)throw new Error(await s.text());return s.ok},[v]),C=c.useCallback(async()=>{const s=await fetch(`${v}/checklist`,{headers:{Accept:"application/json"},credentials:"same-origin"});if(!s.ok)throw new Error(await s.text());$(await s.json())},[v]);c.useEffect(()=>{let s=!1;return(async()=>{O(!0),q(null);try{await L()?await C():$(null)}catch(a){s||q((a==null?void 0:a.message)??"Failed to load checklist")}finally{s||O(!1)}})(),()=>{s=!0}},[L,C]);const R=c.useMemo(()=>t!=null&&t.stages?[...t.stages].sort((s,a)=>s.order-a.order):[],[t==null?void 0:t.stages]),b=c.useMemo(()=>{if(!(t!=null&&t.items))return[];const s=[];for(const a of R)for(const o of t.items)!o.parent_item_id&&o.task.stage.id===a.id&&s.push(o);return s},[t==null?void 0:t.items,R]),T=c.useMemo(()=>t!=null&&t.stages?[...g!=null&&g.length?t.stages.filter(a=>g.includes(a.key)):t.stages].sort((a,o)=>a.order-o.order):[],[t==null?void 0:t.stages,g]),P=c.useMemo(()=>{if(!t)return 0;const s=T.length||1;let a=0;for(const o of T){const r=t.items.filter(d=>d.task.stage.id===o.id&&!d.parent_item_id);r.length&&r.every(d=>Y.has(w(d.state)))&&a++}return Math.round(a/s*100)},[t,T]),j=c.useMemo(()=>{const s=typeof(t==null?void 0:t.progress)=="number"?t.progress:null;return s!==null&&!Number.isNaN(s)?Math.max(0,Math.min(100,Math.round(s))):P},[t==null?void 0:t.progress,P]),f=c.useMemo(()=>t?typeof t.progress=="number"?Math.round(Math.max(0,Math.min(100,t.progress)))>=100:b.length>0&&b.every(s=>Y.has(w(s.state))):!1,[t,b]);c.useEffect(()=>{if(i==="admin"||!S||!f)return;localStorage.getItem(h)==="1"||N(!0)},[i,S,f,h]);const m=c.useMemo(()=>{var a,o;if(p!=null&&p.productLabel||p!=null&&p.date){const r=(a=p.productLabel)==null?void 0:a.toString().trim(),d=te(p.date??null);if(r)return`${r}${d?` — ${d}`:""}`;if(d)return d}let s="Sale Progress";if(i==="client"||i==="agent"){const r=t==null?void 0:t.sale,d=((o=(r==null?void 0:r.product_label)??(r==null?void 0:r.product_name)??(r==null?void 0:r.product)??"")==null?void 0:o.toString().trim())||null,M=(r==null?void 0:r.contracted_at)??(r==null?void 0:r.created_at)??(t==null?void 0:t.checklist_created_at)??(t==null?void 0:t.created_at)??null,X=te(M);return d?`${d}${X?` — ${X}`:""}`:`Sale #${(r==null?void 0:r.number)??(r==null?void 0:r.id)??l}${X?` — ${X}`:""}`}return s},[p==null?void 0:p.productLabel,p==null?void 0:p.date,t,i,l]),n=c.useMemo(()=>{if(!t)return{kind:"none"};const s=b.find(a=>w(a.state)==="pending_review");if(s)return{kind:"waiting",item:s,message:i==="client"?"We’re reviewing your upload.":"Admin review in progress."};if(i==="client"){const a=b.find(r=>G(r)&&w(r.state)==="rejected");if(a)return{kind:"upload",item:a};const o=b.findIndex(r=>!Y.has(w(r.state)));if(o>=0){const r=b[o],M=w(r.state)==="todo"||r.state==="not_started"||r.state==="in_progress"||r.state==="waiting_on_client";return G(r)&&M?{kind:"upload",item:r}:{kind:"gate",message:"No action required. We’re preparing your documents."}}return{kind:"none"}}if(i==="agent"){const a=b.find(d=>G(d)&&(w(d.state)==="todo"||d.state==="waiting_on_client"));if(a)return{kind:"waiting",item:a,message:`Waiting for client upload: ${a.task.label}`};const o=b.find(d=>G(d)&&w(d.state)==="rejected");if(o)return{kind:"waiting",item:o,message:`Client re‑upload required: ${o.task.label}`};const r=b.find(d=>!Y.has(w(d.state)));return r?{kind:"next",item:r,message:"Next step"}:{kind:"none"}}return{kind:"none"}},[t,b,i]),V=c.useCallback(()=>{var s;return(s=_.current)==null?void 0:s.click()},[]),k=c.useCallback(s=>{const a=Array.from(s.target.files??[]);a.length&&(u(o=>[...o,...a]),_.current&&(_.current.value=""))},[]),se=c.useCallback(async()=>{if(n.kind!=="upload"||x.length===0)return;const s=he(),a={Accept:"application/json","X-Requested-With":"XMLHttpRequest"};s&&(a[s.header]=s.token);try{B(!0);const o=new FormData;x.forEach(r=>{o.append("files[]",r,r.name),o.append("titles[]",r.name)}),await fetch(`${v}/checklist/items/${n.item.id}/upload`,{method:"POST",headers:a,credentials:"same-origin",body:o}),u([]),await C()}finally{B(!1)}},[x,v,C,n]);if(J)return e.jsxs(z,{children:[e.jsx(U,{children:e.jsx(I,{children:m})}),e.jsx(H,{children:e.jsx("div",{className:"text-sm text-muted-foreground",children:"Loading…"})})]});if(E||!t)return e.jsxs(z,{children:[e.jsx(U,{children:e.jsx(I,{children:m})}),e.jsx(H,{children:e.jsx("div",{className:"text-sm text-muted-foreground",children:E??"No checklist available for this sale yet."})})]});if((i==="client"||i==="agent")&&f)return S&&y?e.jsxs(z,{children:[e.jsx(U,{children:e.jsx(I,{children:m})}),e.jsx(H,{children:e.jsx("div",{className:"w-full rounded-lg border p-3 md:p-4 bg-emerald-50/80 border-emerald-200 text-emerald-900 dark:bg-emerald-900/30 dark:border-emerald-600/40 dark:text-emerald-50",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ee,{className:"h-4 w-4"}),e.jsx("span",{children:"All set — this sale is complete."})]}),e.jsx(F,{size:"sm",onClick:()=>{localStorage.setItem(h,"1"),N(!1)},children:"Dismiss"})]})})})]}):null;let Z;if(n.kind==="upload"&&w(n.item.state)==="rejected")for(let s=n.item.links.length-1;s>=0;s--){const a=n.item.links[s];if(a.review_state==="rejected"&&a.review_note){Z=a.review_note;break}}const W={upload:"w-full rounded-lg border p-3 md:p-4 bg-blue-50/80 border-blue-200 text-blue-900 dark:bg-blue-900/40 dark:border-blue-500/40 dark:text-blue-50",wait:"w-full rounded-lg border p-3 md:p-4 bg-amber-50/80 border-amber-200 text-amber-900 dark:bg-amber-900/30 dark:border-amber-600/40 dark:text-amber-50",gate:"w-full rounded-lg border p-3 md:p-4 bg-muted/50 border-muted-foreground/20 text-muted-foreground dark:bg-zinc-900/40 dark:border-zinc-600/30 dark:text-zinc-200"};return e.jsxs(z,{"aria-busy":A,children:[e.jsx(U,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(I,{children:m}),e.jsxs("div",{className:"w-48",children:[e.jsx(re,{value:j,className:"dark:bg-white/20 dark:[&>div]:bg-white"}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:[j,"%"]})]})]})}),e.jsxs(H,{className:"flex items-center justify-between",children:[n.kind==="upload"&&e.jsx("div",{className:W.upload,"aria-live":"polite",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"font-medium",children:["Next step: ",n.item.task.label]}),w(n.item.state)==="rejected"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs opacity-80",children:"We need a new file for this step."}),Z&&e.jsxs("div",{className:"text-xs opacity-80 italic",children:["“",Z,"”"]})]}),e.jsxs("div",{className:"text-xs opacity-75",children:["Add one or more documents, then click ",e.jsx("strong",{children:"Submit"}),". After you submit, you won’t be able to add more unless we request changes."]})]}),e.jsx("input",{type:"file",multiple:!0,ref:_,className:"hidden",onChange:k,accept:".pdf,.jpg,.jpeg,.png,.doc,.docx"})]}),x.length>0&&e.jsx("ul",{className:"rounded border bg-white/70 dark:bg-zinc-900/40 divide-y",children:x.map((s,a)=>e.jsxs("li",{className:"flex items-center justify-between px-3 py-2 text-sm",children:[e.jsx("span",{className:"truncate max-w-[22rem]",title:s.name,children:s.name}),e.jsx("button",{type:"button",className:"inline-flex items-center text-xs opacity-70 hover:opacity-100",onClick:()=>u(o=>o.filter((r,d)=>d!==a)),"aria-label":`Remove ${s.name}`,children:e.jsx(ue,{className:"h-4 w-4"})})]},a))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(F,{onClick:V,disabled:A,variant:"outline",children:[e.jsx(me,{className:"h-4 w-4 mr-2"})," Add file(s)"]}),e.jsx(F,{onClick:()=>D(!0),disabled:A||x.length===0,children:"Submit"})]})]})}),n.kind==="waiting"&&e.jsx("div",{className:W.wait,"aria-live":"polite",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ee,{className:"h-4 w-4"}),e.jsx("span",{children:n.message})]})}),n.kind==="gate"&&e.jsx("div",{className:W.gate,"aria-live":"polite",children:e.jsx("div",{className:"text-sm",children:n.message})}),n.kind==="next"&&e.jsx("div",{className:W.wait,"aria-live":"polite",children:e.jsxs("div",{className:"text-sm",children:[n.message??"Next step",": ",e.jsx("span",{className:"font-medium",children:n.item.task.label})]})}),n.kind==="none"&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"No action required right now."})]}),e.jsx(ae,{open:Q,onOpenChange:D,children:e.jsxs(ie,{className:"sm:max-w-[520px]",children:[e.jsxs(ce,{children:[e.jsxs(le,{children:["Submit document",x.length>1?"s":"","?"]}),e.jsxs(oe,{children:["You are about to submit ",x.length," file",x.length>1?"s":""," for review. After you submit, you won’t be able to upload more for this step unless we request changes."]})]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[x.slice(0,5).map((s,a)=>e.jsx("div",{className:"truncate",children:s.name},a)),x.length>5&&e.jsxs("div",{children:["+",x.length-5," more…"]})]}),e.jsxs(de,{className:"gap-2",children:[e.jsx(F,{onClick:()=>{D(!1),se()},children:"Yes, submit"}),e.jsx(F,{variant:"outline",onClick:()=>D(!1),children:"Cancel"})]})]})})]})}function Ce({role:l="client",onlyStageKeys:i,showCompleteOnce:g=!0,hideCompleted:S=!0,limit:p,sourceUrl:v}){const t=v??`/${l}/sales`,[$,J]=c.useState(null),[O,E]=c.useState(!0),[q,A]=c.useState(null);if(c.useEffect(()=>{let u=!1;function Q(h){return h.product_label??h.product_name??(h.product?K(h.product):null)??null}async function D(h){var L,C,R,b,T,P;const y=[];let N=h;for(;N;){const j=await fetch(N,{headers:{Accept:"application/json"},credentials:"same-origin"});if(!j.ok)throw new Error(j.statusText);const f=await j.json();if(f&&typeof f=="object"&&"component"in f&&"props"in f){const n=(L=f.props)==null?void 0:L.sales,V=Array.isArray(n==null?void 0:n.data)?n.data:Array.isArray(n)?n:[];for(const k of V)y.push({id:k.sale_id??k.id,product:k.product??null,created_at:k.created_at??null,contracted_at:k.sale_date??null,progress_cached:((C=k==null?void 0:k.checklistParent)==null?void 0:C.progress_cached)??null,status:k.status??null});N=(n==null?void 0:n.next_page_url)??((R=n==null?void 0:n.links)==null?void 0:R.next)??null}else if(f!=null&&f.data&&Array.isArray(f.data)){const m=f;for(const n of m.data)y.push({id:n.sale_id??n.id,product:n.product??null,created_at:n.created_at??null,contracted_at:n.sale_date??null,progress_cached:((b=n==null?void 0:n.checklistParent)==null?void 0:b.progress_cached)??null,status:n.status??null});N=m.next_page_url??((T=m.links)==null?void 0:T.next)??null}else if(Array.isArray(f)){for(const m of f)y.push({id:m.sale_id??m.id,product:m.product??null,created_at:m.created_at??null,contracted_at:m.sale_date??null,progress_cached:((P=m==null?void 0:m.checklistParent)==null?void 0:P.progress_cached)??null,status:m.status??null});N=null}else N=null}y.sort((j,f)=>{const m=new Date(j.contracted_at??j.created_at??0).getTime();return new Date(f.contracted_at??f.created_at??0).getTime()-m});let _=y;return S&&(_=_.filter(j=>(j.progress_cached??-1)<100)),typeof p=="number"&&(_=_.slice(0,p)),_.map(j=>({...j,product_label:Q(j)}))}return(async()=>{E(!0),A(null);try{const h=await D(t);u||J(h)}catch(h){u||A((h==null?void 0:h.message)??"Failed to load sales")}finally{u||E(!1)}})(),()=>{u=!0}},[t,S,p]),O||q||!$||$.length===0)return null;const B=u=>u.product_label??u.product_name??(u.product?K(u.product):null)??null,x=u=>u.contracted_at??u.created_at??null;return e.jsx("div",{className:"space-y-4",children:$.map(u=>e.jsx(ge,{saleId:u.id,role:l,onlyStageKeys:i,showCompleteOnce:g,titleMeta:{productLabel:B(u),date:x(u)}},u.id))})}export{Ce as S};
